<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat t∆∞ v·∫•n & t·∫°o h·ª£p ƒë·ªìng ‚Ä¢ n8n webhook (lite)</title>
  <meta name="description" content="Giao di·ªán chat g·ª≠i tin nh·∫Øn t·ªõi n8n, ch·ªçn lo·∫°i giao d·ªãch v√† ƒë√≠nh k√®m ·∫£nh gi·∫•y t·ªù ngay d∆∞·ªõi khung chat." />
  <style>
    :root{
      --bg:#0b0e14; --panel:#0f131a; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2937;
      --user:#34d399; --assistant:#60a5fa; --error:#f87171; --radius:16px; --shadow:0 6px 24px rgba(0,0,0,.3);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f7f8; --panel:#ffffff; --text:#1f2328; --muted:#6b7280; --border:#e5e7eb;
        --user:#10b981; --assistant:#2563eb; --error:#ef4444; --shadow:0 6px 24px rgba(0,0,0,.06);
      }
    }

    html, body {height:100%}
    body{ margin:0; background:var(--bg); color:var(--text); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";}
    .app{display:grid; grid-template-rows:auto 1fr auto; height:100%;}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:10; display:flex; gap:.75rem; align-items:center;
      padding:.6rem .9rem; border-bottom:1px solid var(--border);
      backdrop-filter:saturate(180%) blur(8px);
      background: color-mix(in oklab, var(--panel) 88%, transparent);
    }
    .brand{ font-weight:700; letter-spacing:.2px; white-space:nowrap }
    .spacer{flex:1}
    .btn{ cursor:pointer; border:none; border-radius:12px; padding:.5rem .8rem; background:var(--assistant); color:white; font-weight:600; box-shadow:var(--shadow);}
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none;}
    .btn.ghost{ background:transparent; color:var(--assistant); border:1px dashed color-mix(in oklab, var(--assistant) 50%, transparent); }

    .select, .input{
      border:1px solid var(--border); background:var(--panel); color:var(--text);
      border-radius:12px; padding:.55rem .7rem; font:inherit;
    }
    .select{ padding-right:2rem }

    /* Messages */
    .messages{ overflow:auto; padding: 1rem; scroll-behavior:smooth; }
    .empty{ opacity:.7; text-align:center; margin-top: 12vh; }

    .msg{ display:grid; grid-template-columns: 40px 1fr; gap:.75rem; margin:.35rem 0; }
    .avatar{ width:40px; height:40px; border-radius:12px; display:grid; place-items:center; font-weight:700; }
    .avatar.user{ background: color-mix(in oklab, var(--user) 20%, var(--panel)); color: var(--user); border:1px solid color-mix(in oklab, var(--user) 45%, var(--border)); }
    .avatar.assistant{ background: color-mix(in oklab, var(--assistant) 20%, var(--panel)); color: var(--assistant); border:1px solid color-mix(in oklab, var(--assistant) 45%, var(--border)); }
    .bubble{ background: var(--panel); border:1px solid var(--border); border-radius: var(--radius); padding:.85rem .95rem; box-shadow: var(--shadow); white-space: pre-wrap; }
    .meta{ font-size:.8rem; color: var(--muted); margin-top:.35rem; }
    .msg.user .bubble{ border-left:4px solid var(--user); }
    .msg.assistant .bubble{ border-left:4px solid var(--assistant); }
    .bubble.error{ border-left-color: var(--error); outline:1px dashed color-mix(in oklab, var(--error) 60%, var(--border)); }

    .typing{ display:inline-grid; grid-auto-flow:column; gap:.25rem; align-items:center; }
    .typing .dot{ width:8px; height:8px; border-radius:50%; background: var(--muted); opacity:.6; animation: blink 1.4s infinite; }
    .typing .dot:nth-child(2){ animation-delay:.2s } .typing .dot:nth-child(3){ animation-delay:.4s }
    @keyframes blink{0%,80%,100%{opacity:.2} 40%{opacity:1}}

    /* Composer */
    .composer{ border-top:1px solid var(--border); background: color-mix(in oklab, var(--panel) 92%, transparent); }
    .composer .wrap{ padding:.75rem .75rem .5rem; display:grid; gap:.5rem; }
    .compose-row{ display:grid; grid-template-columns:1fr auto auto; gap:.6rem; align-items:end; }
    textarea#input{ width:100%; resize:none; max-height:30vh; min-height:46px; padding:.75rem .9rem; border-radius:12px; background:var(--panel); color:var(--text); border:1px solid var(--border); }
    textarea::placeholder{ color:var(--muted); }

    .hint{ font-size:.8rem; color:var(--muted); display:flex; justify-content:space-between; align-items:center; gap:.5rem; padding:0 .15rem .35rem; }

    /* Thumb bar under chat */
    .thumbbar{
      border-top:1px dashed var(--border);
      padding:.55rem .2rem .65rem;
      display:grid; gap:.4rem;
    }
    .thumbs{
      display:grid; grid-auto-flow:column; grid-auto-columns:120px; gap:.55rem;
      overflow-x:auto; padding:.15rem .5rem;
    }
    .thumb{
      position:relative; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--panel); box-shadow:var(--shadow);
      height:100px;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .thumb .close{
      position:absolute; top:6px; right:6px; cursor:pointer;
      background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.25); color:#fff; padding:.15rem .35rem; border-radius:8px; font-size:.75rem;
    }
    .thumb-meta{ position:absolute; left:6px; bottom:6px; font-size:.72rem; padding:.1rem .35rem; border-radius:6px; border:1px solid var(--border);
                 background:color-mix(in oklab, var(--panel) 92%, transparent); color:var(--muted); }

    .thumbbar .actions{ display:flex; justify-content:space-between; align-items:center; padding:0 .35rem; }
    .link{ color: var(--assistant); text-decoration:none; border-bottom:1px dashed color-mix(in oklab, var(--assistant) 60%, transparent) }
  </style>
</head>
<body>
  <div class="app">
    <!-- Topbar -->
    <header class="topbar">
      <div class="brand">üí¨ Chat t∆∞ v·∫•n lu·∫≠t</div>

      <label class="field" style="max-width:380px; margin-left:.5rem; display:grid; gap:.25rem;">
        <span class="help" style="font-size:.82rem; color:var(--muted)">Lo·∫°i giao d·ªãch</span>
        <select id="txnType" class="select">
          <option value="">‚Äî Ch·ªçn ‚Äî</option>
          <option value="mua_ban">Mua b√°n / Chuy·ªÉn nh∆∞·ª£ng</option>
          <option value="dat_coc">ƒê·∫∑t c·ªçc</option>
          <option value="vay">Vay ti·ªÅn</option>
          <option value="the_chap">Th·∫ø ch·∫•p / C·∫ßm c·ªë</option>
          <option value="cho_thue">Cho thu√™ / Cho m∆∞·ª£n</option>
          <option value="tang_cho">T·∫∑ng cho</option>
          <option value="uy_quyen">U·ª∑ quy·ªÅn</option>
          <option value="khac">Kh√°c</option>
        </select>
      </label>

      <div class="spacer"></div>
      <button class="btn secondary" id="clearChat" title="X√≥a h·ªôi tho·∫°i hi·ªán t·∫°i">X√≥a</button>
    </header>

    <!-- Messages -->
    <main id="messages" class="messages" role="log" aria-live="polite" aria-relevant="additions text">
      <div class="empty" id="empty">
        <p><strong>Xin ch√†o!</strong> H√£y ch·ªçn <em>Lo·∫°i giao d·ªãch</em>, th√™m ·∫£nh gi·∫•y t·ªù b·∫±ng n√∫t <strong>üìé ·∫¢nh gi·∫•y t·ªù</strong> b√™n d∆∞·ªõi, r·ªìi nh·∫≠p c√¢u h·ªèi/ƒë·ªÅ ngh·ªã so·∫°n h·ª£p ƒë·ªìng.</p>
        <p>H·ªá th·ªëng s·∫Ω g·ª≠i ƒë·ªìng th·ªùi t·ªõi 2 webhook: <span class="help">üìã T∆∞ v·∫•n lu·∫≠t</span> v√† <span class="help">üìÑ T·∫°o h·ª£p ƒë·ªìng</span>.</p>
      </div>
    </main>

    <!-- Composer + Thumbbar -->
    <footer class="composer">
      <div class="wrap">
        <div class="compose-row">
          <textarea id="input" placeholder="Nh·∫≠p tin nh·∫Øn‚Ä¶ (Enter ƒë·ªÉ g·ª≠i, Shift+Enter ƒë·ªÉ xu·ªëng d√≤ng)"></textarea>
          <button class="btn secondary" id="pickPhotos" title="Ch·ªçn ho·∫∑c ch·ª•p ·∫£nh gi·∫•y t·ªù">üìé ·∫¢nh gi·∫•y t·ªù</button>
          <button class="btn" id="send">G·ª≠i</button>
          <input id="photoInput" type="file" accept="image/*" capture="environment" multiple style="display:none" />
        </div>
        <div class="hint">
          <span>Payload g·ªìm: <code>transaction_type</code> + <code>photos[]</code> (ƒë√£ n√©n & xo√° EXIF).</span>
          <a class="link" href="#" id="examplePayload">Xem payload m·∫´u</a>
        </div>
        <div class="thumbbar" id="thumbbar" style="display:none;">
          <div class="thumbs" id="thumbs"></div>
          <div class="actions">
            <span id="thumbStat" class="help">0 ·∫£nh</span>
            <a href="#" id="clearPhotos" class="link">Xo√° t·∫•t c·∫£ ·∫£nh</a>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <script>
    // ================== CONFIG ==================
    const WEBHOOK_URLS = {
      tuvan: 'https://demo.vnlawai.com/webhook/luongtuvan',
      hopdong: 'https://demo.vnlawai.com/webhook/luongtaohopdong'
    };
    const SCHEMA_VERSION = 'lawchat-lite-v2';

    const STORAGE = {
      messages: 'n8n:chat:messages',
      data:     'n8n:chat:lite-v2'
    };

    // ================== DOM ==================
    const $input = document.getElementById('input');
    const $send = document.getElementById('send');
    const $messages = document.getElementById('messages');
    const $empty = document.getElementById('empty');
    const $clearChat = document.getElementById('clearChat');
    const $txnType = document.getElementById('txnType');

    const $pickPhotos = document.getElementById('pickPhotos');
    const $photoInput = document.getElementById('photoInput');
    const $thumbbar = document.getElementById('thumbbar');
    const $thumbs = document.getElementById('thumbs');
    const $thumbStat = document.getElementById('thumbStat');
    const $clearPhotos = document.getElementById('clearPhotos');
    const $examplePayload = document.getElementById('examplePayload');

    // ================== STATE ==================
    const state = {
      messages: [],
      data: {
        schema_version: SCHEMA_VERSION,
        transaction_type: '',
        photos: [] // {id, name, type, size, dataUrl}
      }
    };

    // ================== INIT ==================
    try {
      const saved = JSON.parse(localStorage.getItem(STORAGE.messages) || '[]');
      if (Array.isArray(saved)) {
        state.messages = saved;
        for (const m of state.messages) renderMessage(m);
        if (state.messages.length) $empty?.remove();
        scrollToBottom();
      }
    } catch {}

    try {
      const savedData = JSON.parse(localStorage.getItem(STORAGE.data) || 'null');
      if (savedData && savedData.schema_version) state.data = savedData;
    } catch {}
    $txnType.value = state.data.transaction_type || '';
    renderThumbs();
    autosize();

    // ================== EVENTS ==================
    function autosize(){ $input.style.height='auto'; $input.style.height=Math.min($input.scrollHeight, window.innerHeight*0.30)+'px'; }
    $input.addEventListener('input', autosize);
    $input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }});
    $send.addEventListener('click', sendMessage);

    $txnType.addEventListener('change', () => { state.data.transaction_type = $txnType.value; persistData(); });

    $clearChat.addEventListener('click', () => {
      if (!confirm('X√≥a to√†n b·ªô h·ªôi tho·∫°i hi·ªán t·∫°i?')) return;
      state.messages = [];
      localStorage.removeItem(STORAGE.messages);
      $messages.innerHTML = '<div class="empty" id="empty"><p><strong>ƒê√£ x√≥a.</strong> B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán m·ªõi!</p></div>';
      toast('ƒê√£ x√≥a h·ªôi tho·∫°i.');
    });

    $pickPhotos.addEventListener('click', () => $photoInput.click());

    $photoInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      const limitCount = 24;
      if (state.data.photos.length + files.length > limitCount) toast(`T·ªëi ƒëa ${limitCount} ·∫£nh. M·ªôt s·ªë ·∫£nh s·∫Ω kh√¥ng ƒë∆∞·ª£c th√™m.`);
      for (const file of files.slice(0, limitCount - state.data.photos.length)) {
        const item = await readAndCompressImage(file, 1600, 0.75); // remove EXIF via canvas + n√©n
        state.data.photos.push(item);
      }
      persistData(); renderThumbs(); $photoInput.value = '';
    });

    $clearPhotos.addEventListener('click', (e) => {
      e.preventDefault();
      if (!state.data.photos.length) return;
      if (!confirm('Xo√° to√†n b·ªô ·∫£nh?')) return;
      state.data.photos = []; persistData(); renderThumbs();
    });

    $examplePayload.addEventListener('click', (e) => {
      e.preventDefault();
      const example = buildPayload('[V√≠ d·ª•] So·∫°n h·ª£p ƒë·ªìng u·ª∑ quy·ªÅn nh√† ƒë·∫•t');
      alert('Payload m·∫´u:\n\n' + JSON.stringify(example, null, 2) + '\n\nTrong n8n: \n- Lo·∫°i GD: {{$json.body.profile.transaction_type}}\n- ·∫¢nh: {{$json.body.profile.photos}}');
    });

    // ================== HELPERS ==================
    function toast(text){
      const t = document.createElement('div');
      t.textContent = text;
      Object.assign(t.style, { position:'fixed', left:'50%', bottom:'20px', transform:'translateX(-50%)',
        background:'var(--panel)', color:'var(--text)', padding:'10px 14px', border:'1px solid var(--border)', borderRadius:'12px', boxShadow:'var(--shadow)', zIndex:10000 });
      document.body.appendChild(t); setTimeout(() => t.remove(), 1800);
    }
    function scrollToBottom(){ $messages.scrollTop = $messages.scrollHeight; }
    function now(){ return new Date().toISOString(); }
    function fmt(ts){ try{ const d=new Date(ts); return d.toLocaleString('vi-VN'); }catch{ return ts; } }

    function renderMessage(m){
      const wrap = document.createElement('div'); wrap.className = `msg ${m.role}`;
      const avatar = document.createElement('div'); avatar.className = `avatar ${m.role}`; avatar.textContent = m.role === 'user' ? 'U' : 'A';
      const bubble = document.createElement('div'); bubble.className = 'bubble' + (m.error ? ' error' : '');
      const hasPhotos = m.meta?.hasPhotos;
      bubble.textContent = m.content + (hasPhotos ? '\n\n‚Äî\n(ƒê√£ g·ª≠i k√®m ·∫£nh gi·∫•y t·ªù)' : '');
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = m.error ? `L·ªói ‚Ä¢ ${fmt(m.ts)}` : `${m.role==='user' ? 'B·∫°n' : 'Tr·ª£ l√Ω'} ‚Ä¢ ${fmt(m.ts)}`;
      const right = document.createElement('div'); right.appendChild(bubble); right.appendChild(meta);
      wrap.appendChild(avatar); wrap.appendChild(right); $messages.appendChild(wrap);
    }

    function renderTyping(apiType){
      const wrap = document.createElement('div'); wrap.className='msg assistant'; wrap.id=`typing-${apiType}`;
      const avatar = document.createElement('div'); avatar.className='avatar assistant'; avatar.textContent='A';
      const bubble = document.createElement('div'); bubble.className='bubble';
      const typing = document.createElement('div'); typing.className='typing'; typing.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>'; bubble.appendChild(typing);
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = apiType==='tuvan' ? 'üìã ƒêang t∆∞ v·∫•n‚Ä¶' : 'üìÑ ƒêang t·∫°o h·ª£p ƒë·ªìng‚Ä¶';
      const right = document.createElement('div'); right.appendChild(bubble); right.appendChild(meta);
      wrap.appendChild(avatar); wrap.appendChild(right); $messages.appendChild(wrap); scrollToBottom();
    }
    function removeTyping(apiType){ document.getElementById(`typing-${apiType}`)?.remove(); }
    function persistMessages(){ localStorage.setItem(STORAGE.messages, JSON.stringify(state.messages.slice(-200))); }
    function persistData(){ localStorage.setItem(STORAGE.data, JSON.stringify(state.data)); }

    function renderThumbs(){
      $thumbs.innerHTML = '';
      const n = state.data.photos.length;
      $thumbbar.style.display = n ? 'block' : 'none';
      $thumbStat.textContent = n ? `${n} ·∫£nh ƒë√£ ch·ªçn` : '0 ·∫£nh';
      for (const photo of state.data.photos){
        const item = document.createElement('div'); item.className='thumb'; item.dataset.id = photo.id;
        const img = document.createElement('img'); img.src = photo.dataUrl;
        const close = document.createElement('button'); close.className='close'; close.type='button'; close.textContent='‚úï';
        const meta = document.createElement('span'); meta.className='thumb-meta'; meta.textContent = `${Math.round(photo.size/1024)} KB`;
        close.addEventListener('click', () => {
          state.data.photos = state.data.photos.filter(p => p.id !== photo.id); persistData(); renderThumbs();
        });
        item.appendChild(img); item.appendChild(close); item.appendChild(meta);
        $thumbs.appendChild(item);
      }
    }

    // Read + compress image, remove EXIF via canvas
    async function readAndCompressImage(file, maxSize=1600, quality=0.75){
      const id = crypto.randomUUID?.() || String(Math.random());
      const name = file.name || ('image-' + id + '.jpg');
      const type = 'image/jpeg';
      const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject; reader.readAsDataURL(file);
      });
      const img = await new Promise((resolve, reject) => { const i=new Image(); i.onload=()=>resolve(i); i.onerror=reject; i.src=dataUrl; });
      const {width, height} = fitContain(img.width, img.height, maxSize);
      const canvas = document.createElement('canvas'); canvas.width=width; canvas.height=height;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
      const out = canvas.toDataURL(type, quality);
      const size = Math.ceil(atob(out.split(',')[1]).length);
      return { id, name, type, size, dataUrl: out };
    }
    function fitContain(w, h, max){ if(Math.max(w,h)<=max) return {width:w, height:h}; const r = w>h ? max/w : max/h; return {width:Math.round(w*r), height:Math.round(h*r)}; }

    // ============== SEND MESSAGE ==============
    async function sendMessage(){
      const text = $input.value.trim();
      if (!text) return;

      $send.disabled = true; $input.disabled = true;
      $empty?.remove();

      const hasPhotos = state.data.photos.length > 0;
      const userMsg = { id: crypto.randomUUID?.() || String(Math.random()), role:'user', content:text, ts: now(), meta: { hasPhotos } };
      state.messages.push(userMsg); renderMessage(userMsg); scrollToBottom();
      $input.value=''; autosize();

      renderTyping('tuvan'); renderTyping('hopdong');

      // History (10 tin tr∆∞·ªõc ƒë√≥, kh√¥ng t√≠nh tin hi·ªán t·∫°i)
      const history = state.messages.slice(-11, -1).map(({role, content, ts}) => ({role, content, ts}));

      // Build payload
      const payload = buildPayload(text, history);

      // Call both webhooks in parallel
      const results = await Promise.allSettled([
        callAPI(WEBHOOK_URLS.tuvan, payload),
        callAPI(WEBHOOK_URLS.hopdong, payload)
      ]);

      // Handle result 1
      removeTyping('tuvan');
      if (results[0].status === 'fulfilled'){
        const botMsg1 = { id: crypto.randomUUID?.() || String(Math.random()), role:'assistant', content:`üìã T∆∞ v·∫•n lu·∫≠t:\n\n${results[0].value}`, ts: now(), apiType:'tuvan' };
        state.messages.push(botMsg1); renderMessage(botMsg1);
      } else {
        const errMsg1 = { id: crypto.randomUUID?.() || String(Math.random()), role:'assistant', content:`üìã T∆∞ v·∫•n lu·∫≠t - L·ªói: ${results[0].reason}`, ts: now(), error:true };
        state.messages.push(errMsg1); renderMessage(errMsg1);
      }

      // Handle result 2
      removeTyping('hopdong');
      if (results[1].status === 'fulfilled'){
        const botMsg2 = { id: crypto.randomUUID?.() || String(Math.random()), role:'assistant', content:`üìÑ T·∫°o h·ª£p ƒë·ªìng:\n\n${results[1].value}`, ts: now(), apiType:'hopdong' };
        state.messages.push(botMsg2); renderMessage(botMsg2);
      } else {
        const errMsg2 = { id: crypto.randomUUID?.() || String(Math.random()), role:'assistant', content:`üìÑ T·∫°o h·ª£p ƒë·ªìng - L·ªói: ${results[1].reason}`, ts: now(), error:true };
        state.messages.push(errMsg2); renderMessage(errMsg2);
      }

      scrollToBottom(); persistMessages();
      $send.disabled = false; $input.disabled = false; $input.focus();

      if (!state.data.transaction_type){
        toast('G·ª£i √Ω: Ch∆∞a ch·ªçn "Lo·∫°i giao d·ªãch". H√£y ch·ªçn ƒë·ªÉ h·ª£p ƒë·ªìng d√πng ƒë√∫ng m·∫´u.');
      }
    }

    function buildPayload(text, historyOverride){
      const history = historyOverride ?? state.messages.slice(-11, -1).map(({role, content, ts}) => ({role, content, ts}));
      const photos = (state.data.photos||[]).map(({id,name,type,size,dataUrl}) => ({id,name,type,size,dataUrl}));
      const profile = { schema_version: state.data.schema_version, transaction_type: state.data.transaction_type, photos };
      return {
        message: text,
        link: window.location.href,
        history,
        profile,
        meta: {
          sent_at: now(),
          source: 'webchat',
          schema_version: SCHEMA_VERSION,
          warnings: profile.transaction_type ? [] : ['transaction_type_missing']
        }
      };
    }

    async function callAPI(url, payload){
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 240000);
      try{
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), signal: controller.signal });
        clearTimeout(timeout);
        if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + res.statusText);
        const ct = res.headers.get('content-type') || '';
        let replyText = '';
        if (ct.includes('application/json')){
          const data = await res.json();
          replyText = extractReply(data);
        } else {
          replyText = await res.text();
        }
        return String(replyText ?? '').trim() || '[Kh√¥ng c√≥ n·ªôi dung tr·∫£ l·ªùi]';
      }catch(err){
        clearTimeout(timeout);
        throw err?.message || err;
      }
    }

    function extractReply(obj){
      if (!obj) return '';
      if (typeof obj === 'string') return obj;
      if (typeof obj.message === 'string') return obj.message;
      if (typeof obj.answer === 'string') return obj.answer;
      if (typeof obj.reply === 'string') return obj.reply;
      if (obj.data){
        if (typeof obj.data === 'string') return obj.data;
        if (typeof obj.data.message === 'string') return obj.data.message;
        if (typeof obj.data.answer === 'string') return obj.data.answer;
        if (typeof obj.data.reply === 'string') return obj.data.reply;
      }
      if (Array.isArray(obj.messages)){
        return obj.messages.map(m => m.content || m.text || '').filter(Boolean).join('\n');
      }
      try{ return JSON.stringify(obj); }catch{ return String(obj); }
    }
  </script>
</body>
</html>
