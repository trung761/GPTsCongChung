<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat tÆ° váº¥n & táº¡o há»£p Ä‘á»“ng â€¢ n8n webhook (lite)</title>
  <meta name="description" content="Giao diá»‡n chat gá»­i tin nháº¯n tá»›i n8n, chá»n loáº¡i giao dá»‹ch vÃ  Ä‘Ã­nh kÃ¨m áº£nh giáº¥y tá» ngay dÆ°á»›i khung chat." />
  <style>
    :root{
      --bg:#0b0e14; --panel:#0f131a; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2937;
      --user:#34d399; --assistant:#60a5fa; --error:#f87171; --radius:16px; --shadow:0 6px 24px rgba(0,0,0,.3);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f7f8; --panel:#ffffff; --text:#1f2328; --muted:#6b7280; --border:#e5e7eb;
        --user:#10b981; --assistant:#2563eb; --error:#ef4444; --shadow:0 6px 24px rgba(0,0,0,.06);
      }
    }

    html, body {height:100%}
    body{ margin:0; background:var(--bg); color:var(--text); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";}
    .app{display:grid; grid-template-rows:auto 1fr auto; height:100%;}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:10; display:flex; gap:.75rem; align-items:center;
      padding:.6rem .9rem; border-bottom:1px solid var(--border);
      backdrop-filter:saturate(180%) blur(8px);
      background: color-mix(in oklab, var(--panel) 88%, transparent);
    }
    .brand{ font-weight:700; letter-spacing:.2px; white-space:nowrap }
    .spacer{flex:1}
    .btn{ cursor:pointer; border:none; border-radius:12px; padding:.5rem .8rem; background:var(--assistant); color:white; font-weight:600; box-shadow:var(--shadow);}
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none;}
    .btn.ghost{ background:transparent; color:var(--assistant); border:1px dashed color-mix(in oklab, var(--assistant) 50%, transparent); }

    .select, .input{
      border:1px solid var(--border); background:var(--panel); color:var(--text);
      border-radius:12px; padding:.55rem .7rem; font:inherit;
    }
    .select{ padding-right:2rem }

    /* Messages */
    .messages{ overflow:auto; padding: 1rem; scroll-behavior:smooth; }
    .empty{ opacity:.7; text-align:center; margin-top: 12vh; }

    .msg{ display:grid; grid-template-columns: 40px 1fr; gap:.75rem; margin:.35rem 0; }
    .avatar{ width:40px; height:40px; border-radius:12px; display:grid; place-items:center; font-weight:700; }
    .avatar.user{ background: color-mix(in oklab, var(--user) 20%, var(--panel)); color: var(--user); border:1px solid color-mix(in oklab, var(--user) 45%, var(--border)); }
    .avatar.assistant{ background: color-mix(in oklab, var(--assistant) 20%, var(--panel)); color: var(--assistant); border:1px solid color-mix(in oklab, var(--assistant) 45%, var(--border)); }
    .bubble{ background: var(--panel); border:1px solid var(--border); border-radius: var(--radius); padding:.85rem .95rem; box-shadow: var(--shadow); white-space: pre-wrap; }
    .meta{ font-size:.8rem; color: var(--muted); margin-top:.35rem; }
    .msg.user .bubble{ border-left:4px solid var(--user); }
    .msg.assistant .bubble{ border-left:4px solid var(--assistant); }
    .bubble.error{ border-left-color: var(--error); outline:1px dashed color-mix(in oklab, var(--error) 60%, var(--border)); }

    .typing{ display:inline-grid; grid-auto-flow:column; gap:.25rem; align-items:center; }
    .typing .dot{ width:8px; height:8px; border-radius:50%; background: var(--muted); opacity:.6; animation: blink 1.4s infinite; }
    .typing .dot:nth-child(2){ animation-delay:.2s } .typing .dot:nth-child(3){ animation-delay:.4s }
    @keyframes blink{0%,80%,100%{opacity:.2} 40%{opacity:1}}

    /* Composer */
    .composer{ border-top:1px solid var(--border); background: color-mix(in oklab, var(--panel) 92%, transparent); }
    .composer .wrap{ padding:.75rem .75rem .5rem; display:grid; gap:.5rem; }
    .compose-row{ display:grid; grid-template-columns:1fr auto auto; gap:.6rem; align-items:end; }
    textarea#input{ width:100%; resize:none; max-height:30vh; min-height:46px; padding:.75rem .9rem; border-radius:12px; background:var(--panel); color:var(--text); border:1px solid var(--border); }
    textarea::placeholder{ color:var(--muted); }

    .hint{ font-size:.8rem; color:var(--muted); display:flex; justify-content:space-between; align-items:center; gap:.5rem; padding:0 .15rem .35rem; }

    /* Thumb bar under chat */
    .thumbbar{
      border-top:1px dashed var(--border);
      padding:.55rem .2rem .65rem;
      display:grid; gap:.4rem;
    }
    .thumbs{
      display:grid; grid-auto-flow:column; grid-auto-columns:120px; gap:.55rem;
      overflow-x:auto; padding:.15rem .5rem;
    }
    .thumb{
      position:relative; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--panel); box-shadow:var(--shadow);
      height:100px;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .thumb .close{
      position:absolute; top:6px; right:6px; cursor:pointer;
      background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.25); color:#fff; padding:.15rem .35rem; border-radius:8px; font-size:.75rem;
    }
    .thumb-meta{ position:absolute; left:6px; bottom:6px; font-size:.72rem; padding:.1rem .35rem; border-radius:6px; border:1px solid var(--border);
                 background:color-mix(in oklab, var(--panel) 92%, transparent); color:var(--muted); }

    .thumbbar .actions{ display:flex; justify-content:space-between; align-items:center; padding:0 .35rem; }
    .link{ color: var(--assistant); text-decoration:none; border-bottom:1px dashed color-mix(in oklab, var(--assistant) 60%, transparent) }
  </style>
</head>
<body>
  <div class="app">
    <!-- Topbar -->
    <header class="topbar">
      <div class="brand">ğŸ’¬ Chat tÆ° váº¥n luáº­t</div>

      <label class="field" style="max-width:380px; margin-left:.5rem; display:grid; gap:.25rem;">
        <span class="help" style="font-size:.82rem; color:var(--muted)">Loáº¡i giao dá»‹ch</span>
        <select id="txnType" class="select">
          <option value="">â€” Chá»n loáº¡i giao dá»‹ch â€”</option>

          <option value="gd01">1. VÄƒn báº£n lá»±a chá»n ngÆ°á»i giÃ¡m há»™</option>
          <option value="gd02">2. VÄƒn báº£n táº·ng cho báº¥t Ä‘á»™ng sáº£n</option>
          <option value="gd03">3. Di chÃºc cá»§a ngÆ°á»i háº¡n cháº¿ thá»ƒ cháº¥t / khÃ´ng biáº¿t chá»¯</option>
          <option value="gd04">4. VÄƒn báº£n á»§y quyá»n Ä‘áº¡i diá»‡n khÃ¡ng cÃ¡o vá»¥ viá»‡c dÃ¢n sá»±</option>
          <option value="gd05">5. HÄ mua bÃ¡n / thuÃª mua nhÃ  á»Ÿ, cÃ´ng trÃ¬nh (giá»¯a cÃ¡ nhÃ¢n)</option>

          <option value="gd06">6. HÄ giao dá»‹ch nhÃ  á»Ÿ (mua bÃ¡n, thuÃª mua, táº·ng cho, Ä‘á»•i, gÃ³p vá»‘n, tháº¿ cháº¥p)</option>
          <option value="gd07">7. VÄƒn báº£n thá»«a káº¿ nhÃ  á»Ÿ</option>
          <option value="gd08">8. HÄ chuyá»ƒn nhÆ°á»£ng / táº·ng cho / tháº¿ cháº¥p / gÃ³p vá»‘n QSDÄ vÃ  tÃ i sáº£n gáº¯n liá»n</option>
          <option value="gd09">9. VÄƒn báº£n vá» thá»«a káº¿ QSDÄ, QSDÄ vÃ  tÃ i sáº£n gáº¯n liá»n</option>
          <option value="gd10">10. Giáº¥y tá» mua bÃ¡n / táº·ng cho / Ä‘á»•i / thá»«a káº¿ nhÃ  á»Ÿ trÆ°á»›c 01/7/2006</option>

          <option value="gd11">11. HÄ thuÃª Ä‘áº¥t / gÃ³p vá»‘n / há»£p tÃ¡c hoáº·c vÄƒn báº£n Ä‘á»“ng Ã½ xÃ¢y dá»±ng nhÃ  á»Ÿ</option>
          <option value="gd12">12. HÄ thuÃª Ä‘áº¥t / gÃ³p vá»‘n / há»£p tÃ¡c hoáº·c vÄƒn báº£n Ä‘á»“ng Ã½ xÃ¢y dá»±ng cÃ´ng trÃ¬nh</option>
          <option value="gd13">13. VÄƒn báº£n thá»a thuáº­n cháº¿ Ä‘á»™ tÃ i sáº£n vá»£ chá»“ng trÆ°á»›c khi káº¿t hÃ´n</option>
          <option value="gd14">14. VÄƒn báº£n thá»a thuáº­n vá» viá»‡c mang thai há»™</option>
          <option value="gd15">15. VÄƒn báº£n sá»­a Ä‘á»•i, bá»• sung thá»a thuáº­n vá» cháº¿ Ä‘á»™ tÃ i sáº£n cá»§a vá»£ chá»“ng</option>

          <option value="gd16">16. Há»£p Ä‘á»“ng cho thuÃª doanh nghiá»‡p tÆ° nhÃ¢n</option>
          <option value="gd17">17. VÄƒn báº£n á»§y quyá»n Ä‘áº¡i diá»‡n khÃ¡ng cÃ¡o báº£n Ã¡n, quyáº¿t Ä‘á»‹nh cá»§a tÃ²a Ã¡n cáº¥p sÆ¡ tháº©m trong vá»¥ viá»‡c hÃ nh chÃ­nh</option>
          <option value="gd18">18. VÄƒn báº£n á»§y quyá»n cá»§a ngÆ°á»i cÃ³ tÃªn trong HÄ thuÃª nhÃ  á»Ÿ Ä‘Ã£ xuáº¥t cáº£nh cho thÃ nh viÃªn khÃ¡c Ä‘á»©ng tÃªn mua nhÃ  á»Ÿ cÅ© thuá»™c tÃ i sáº£n cÃ´ng</option>
          <option value="gd19">19. Há»£p Ä‘á»“ng chuyá»ƒn nhÆ°á»£ng há»£p Ä‘á»“ng kinh doanh báº¥t Ä‘á»™ng sáº£n</option>
          <option value="gd20">20. VÄƒn báº£n thá»a thuáº­n cá»§a cÃ¡c thÃ nh viÃªn cÃ³ chung QSDÄ Ä‘á»“ng Ã½ Ä‘Æ°a QSDÄ vÃ o doanh nghiá»‡p</option>

          <option value="gd21">21. VÄƒn báº£n á»§y quyá»n giáº£i quyáº¿t viá»‡c thi hÃ nh Ã¡n liÃªn quan Ä‘áº¿n tÃ i sáº£n khi ngÆ°á»i pháº£i thi hÃ nh Ã¡n xuáº¥t cáº£nh</option>
          <option value="gd22">22. VÄƒn báº£n á»§y quyá»n thá»±c hiá»‡n quyá»n khiáº¿u náº¡i</option>
          <option value="gd23">23. Há»£p Ä‘á»“ng chuyá»ƒn nhÆ°á»£ng VÄƒn phÃ²ng Thá»«a phÃ¡t láº¡i</option>
          <option value="gd24">24. CÃ¡c giao dá»‹ch khÃ¡c theo quy Ä‘á»‹nh cá»§a luáº­t vÃ  nghá»‹ Ä‘á»‹nh</option>
        </select>
      </label>

      <div class="spacer"></div>
      <button class="btn secondary" id="clearChat" title="XÃ³a há»™i thoáº¡i hiá»‡n táº¡i">XÃ³a</button>
    </header>

    <!-- Messages -->
    <main id="messages" class="messages" role="log" aria-live="polite" aria-relevant="additions text">
      <div class="empty" id="empty">
        <p><strong>Xin chÃ o!</strong> HÃ£y chá»n <em>Loáº¡i giao dá»‹ch</em>, thÃªm áº£nh giáº¥y tá» báº±ng nÃºt <strong>ğŸ“ áº¢nh giáº¥y tá»</strong> bÃªn dÆ°á»›i, rá»“i nháº­p cÃ¢u há»i/Ä‘á» nghá»‹ soáº¡n há»£p Ä‘á»“ng.</p>
        <p>Há»‡ thá»‘ng sáº½ gá»­i Ä‘á»“ng thá»i tá»›i 2 webhook: <span class="help">ğŸ“‹ TÆ° váº¥n luáº­t</span> vÃ  <span class="help">ğŸ“„ Táº¡o há»£p Ä‘á»“ng</span>.</p>
      </div>
    </main>

    <!-- Composer + Thumbbar -->
    <footer class="composer">
      <div class="wrap">
        <div class="compose-row">
          <textarea id="input" placeholder="Nháº­p tin nháº¯nâ€¦ (Enter Ä‘á»ƒ gá»­i, Shift+Enter Ä‘á»ƒ xuá»‘ng dÃ²ng)"></textarea>
          <button class="btn secondary" id="pickPhotos" title="Chá»n hoáº·c chá»¥p áº£nh giáº¥y tá»">ğŸ“ áº¢nh giáº¥y tá»</button>
          <button class="btn" id="send">Gá»­i</button>
          <input id="photoInput" type="file" accept="image/*" capture="environment" multiple style="display:none" />
        </div>
        <div class="hint">
          <span>Payload gá»“m: <code>transaction_type</code> + <code>photos[]</code> (Ä‘Ã£ nÃ©n & xoÃ¡ EXIF).</span>
          <a class="link" href="#" id="examplePayload">Xem payload máº«u</a>
        </div>
        <div class="thumbbar" id="thumbbar" style="display:none;">
          <div class="thumbs" id="thumbs"></div>
          <div class="actions">
            <span id="thumbStat" class="help">0 áº£nh</span>
            <a href="#" id="clearPhotos" class="link">XoÃ¡ táº¥t cáº£ áº£nh</a>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <script>
    // ================== CONFIG ==================
    const WEBHOOK_URLS = {
      tuvan: 'https://demo.vnlawai.com/webhook/luongtuvan',
      hopdong: 'https://demo.vnlawai.com/webhook/luongtaohopdong'
    };
    const SCHEMA_VERSION = 'lawchat-lite-v2';

    const STORAGE = {
      messages: 'n8n:chat:messages',
      data:     'n8n:chat:lite-v2'
    };

    // ================== DOM ==================
    const $input = document.getElementById('input');
    const $send = document.getElementById('send');
    const $messages = document.getElementById('messages');
    const $empty = document.getElementById('empty');
    const $clearChat = document.getElementById('clearChat');
    const $txnType = document.getElementById('txnType');

    const $pickPhotos = document.getElementById('pickPhotos');
    const $photoInput = document.getElementById('photoInput');
    const $thumbbar = document.getElementById('thumbbar');
    const $thumbs = document.getElementById('thumbs');
    const $thumbStat = document.getElementById('thumbStat');
    const $clearPhotos = document.getElementById('clearPhotos');
    const $examplePayload = document.getElementById('examplePayload');

    // ================== STATE ==================
    const state = {
      messages: [],
      data: {
        schema_version: SCHEMA_VERSION,
        transaction_type: '',
        photos: [] // {id, name, type, size, dataUrl}
      }
    };

    // ================== INIT ==================
    try {
      const saved = JSON.parse(localStorage.getItem(STORAGE.messages) || '[]');
      if (Array.isArray(saved)) {
        state.messages = saved;
        for (const m of state.messages) renderMessage(m);
        if (state.messages.length) $empty?.remove();
        scrollToBottom();
      }
    } catch {}

    try {
      const savedData = JSON.parse(localStorage.getItem(STORAGE.data) || 'null');
      if (savedData && savedData.schema_version) state.data = savedData;
    } catch {}
    $txnType.value = state.data.transaction_type || '';
    renderThumbs();
    autosize();

    // ================== EVENTS ==================
    function autosize(){ $input.style.height='auto'; $input.style.height=Math.min($input.scrollHeight, window.innerHeight*0.30)+'px'; }
    $input.addEventListener('input', autosize);
    $input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }});
    $send.addEventListener('click', sendMessage);

    $txnType.addEventListener('change', () => { state.data.transaction_type = $txnType.value; persistData(); });

    $clearChat.addEventListener('click', () => {
      if (!confirm('XÃ³a toÃ n bá»™ há»™i thoáº¡i hiá»‡n táº¡i?')) return;
      state.messages = [];
      localStorage.removeItem(STORAGE.messages);
      $messages.innerHTML = '<div class="empty" id="empty"><p><strong>ÄÃ£ xÃ³a.</strong> Báº¯t Ä‘áº§u cuá»™c trÃ² chuyá»‡n má»›i!</p></div>';
      toast('ÄÃ£ xÃ³a há»™i thoáº¡i.');
    });

    $pickPhotos.addEventListener('click', () => $photoInput.click());

    $photoInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      const limitCount = 24;
      if (state.data.photos.length + files.length > limitCount) toast(`Tá»‘i Ä‘a ${limitCount} áº£nh. Má»™t sá»‘ áº£nh sáº½ khÃ´ng Ä‘Æ°á»£c thÃªm.`);
      for (const file of files.slice(0, limitCount - state.data.photos.length)) {
        const item = await readAndCompressImage(file, 1200, 0.65); // NÃ©n máº¡nh hÆ¡n: 1200px, quality 0.65
        state.data.photos.push(item);
      }
      persistData(); renderThumbs(); $photoInput.value = '';
    });

    $clearPhotos.addEventListener('click', (e) => {
      e.preventDefault();
      if (!state.data.photos.length) return;
      if (!confirm('XoÃ¡ toÃ n bá»™ áº£nh?')) return;
      state.data.photos = []; persistData(); renderThumbs();
    });

    $examplePayload.addEventListener('click', (e) => {
      e.preventDefault();
      const example = buildPayload('[VÃ­ dá»¥] Soáº¡n há»£p Ä‘á»“ng uá»· quyá»n nhÃ  Ä‘áº¥t');
      alert('Payload máº«u:\n\n' + JSON.stringify(example, null, 2) + '\n\nTrong n8n: \n- Loáº¡i GD: {{$json.body.profile.transaction_type}}\n- áº¢nh: {{$json.body.profile.photos}}');
    });

    // ================== HELPERS ==================
    function toast(text){
      const t = document.createElement('div');
      t.textContent = text;
      Object.assign(t.style, { position:'fixed', left:'50%', bottom:'20px', transform:'translateX(-50%)',
        background:'var(--panel)', color:'var(--text)', padding:'10px 14px', border:'1px solid var(--border)', borderRadius:'12px', boxShadow:'var(--shadow)', zIndex:10000 });
      document.body.appendChild(t); setTimeout(() => t.remove(), 1800);
    }
    function scrollToBottom(){ $messages.scrollTop = $messages.scrollHeight; }
    function now(){ return new Date().toISOString(); }
    function fmt(ts){ try{ const d=new Date(ts); return d.toLocaleString('vi-VN'); }catch{ return ts; } }

    function renderMessage(m){
      const wrap = document.createElement('div'); wrap.className = `msg ${m.role}`;
      const avatar = document.createElement('div'); avatar.className = `avatar ${m.role}`; avatar.textContent = m.role === 'user' ? 'U' : 'A';
      const bubble = document.createElement('div'); bubble.className = 'bubble' + (m.error ? ' error' : '');
      const hasPhotos = m.meta?.hasPhotos;
      bubble.textContent = m.content + (hasPhotos ? '\n\nâ€”\n(ÄÃ£ gá»­i kÃ¨m áº£nh giáº¥y tá»)' : '');
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = m.error ? `Lá»—i â€¢ ${fmt(m.ts)}` : `${m.role==='user' ? 'Báº¡n' : 'Trá»£ lÃ½'} â€¢ ${fmt(m.ts)}`;
      const right = document.createElement('div'); right.appendChild(bubble); right.appendChild(meta);
      wrap.appendChild(avatar); wrap.appendChild(right); $messages.appendChild(wrap);
    }

    function renderTyping(apiType){
      const wrap = document.createElement('div'); wrap.className='msg assistant'; wrap.id=`typing-${apiType}`;
      const avatar = document.createElement('div'); avatar.className='avatar assistant'; avatar.textContent='A';
      const bubble = document.createElement('div'); bubble.className='bubble';
      const typing = document.createElement('div'); typing.className='typing'; typing.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>'; bubble.appendChild(typing);
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = apiType==='tuvan' ? 'ğŸ“‹ Äang tÆ° váº¥nâ€¦' : 'ğŸ“„ Äang táº¡o há»£p Ä‘á»“ngâ€¦';
      const right = document.createElement('div'); right.appendChild(bubble); right.appendChild(meta);
      wrap.appendChild(avatar); wrap.appendChild(right); $messages.appendChild(wrap); scrollToBottom();
    }
    function removeTyping(apiType){ document.getElementById(`typing-${apiType}`)?.remove(); }
    function persistMessages(){ localStorage.setItem(STORAGE.messages, JSON.stringify(state.messages.slice(-200))); }
    function persistData(){ localStorage.setItem(STORAGE.data, JSON.stringify(state.data)); }

    function renderThumbs(){
      $thumbs.innerHTML = '';
      const n = state.data.photos.length;
      $thumbbar.style.display = n ? 'block' : 'none';
      $thumbStat.textContent = n ? `${n} áº£nh Ä‘Ã£ chá»n` : '0 áº£nh';
      for (const photo of state.data.photos){
        const item = document.createElement('div'); item.className='thumb'; item.dataset.id = photo.id;
        const img = document.createElement('img'); img.src = photo.dataUrl;
        const close = document.createElement('button'); close.className='close'; close.type='button'; close.textContent='âœ•';
        const meta = document.createElement('span'); meta.className='thumb-meta'; meta.textContent = `${Math.round(photo.size/1024)} KB`;
        close.addEventListener('click', () => {
          state.data.photos = state.data.photos.filter(p => p.id !== photo.id); persistData(); renderThumbs();
        });
        item.appendChild(img); item.appendChild(close); item.appendChild(meta);
        $thumbs.appendChild(item);
      }
    }

    // Read + compress image, remove EXIF via canvas
    async function readAndCompressImage(file, maxSize=1200, quality=0.65){
      const id = crypto.randomUUID?.() || String(Math.random());
      const name = file.name || ('image-' + id + '.jpg');
      const type = 'image/jpeg';
      const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject; reader.readAsDataURL(file);
      });
      const img = await new Promise((resolve, reject) => { const i=new Image(); i.onload=()=>resolve(i); i.onerror=reject; i.src=dataUrl; });
      const {width, height} = fitContain(img.width, img.height, maxSize);
      const canvas = document.createElement('canvas'); canvas.width=width; canvas.height=height;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
      const out = canvas.toDataURL(type, quality);
      const size = Math.ceil(atob(out.split(',')[1]).length);
      return { id, name, type, size, dataUrl: out };
    }
    function fitContain(w, h, max){ if(Math.max(w,h)<=max) return {width:w, height:h}; const r = w>h ? max/w : max/h; return {width:Math.round(w*r), height:Math.round(h*r)}; }

    // ============== SEND MESSAGE ==============
    async function sendMessage(){
      const text = $input.value.trim();
      if (!text) return;

      $send.disabled = true; $input.disabled = true;
      $empty?.remove();

      const hasPhotos = state.data.photos.length > 0;
      const userMsg = { id: crypto.randomUUID?.() || String(Math.random()), role:'user', content:text, ts: now(), meta: { hasPhotos } };
      state.messages.push(userMsg); renderMessage(userMsg); scrollToBottom();
      $input.value=''; autosize();

      renderTyping('tuvan'); renderTyping('hopdong');

      // History (10 tin trÆ°á»›c Ä‘Ã³, khÃ´ng tÃ­nh tin hiá»‡n táº¡i)
      const history = state.messages.slice(-11, -1).map(({role, content, ts}) => ({role, content, ts}));

      // Build payload (pháº£i build trÆ°á»›c khi xÃ³a áº£nh)
      const payload = buildPayload(text, history);
      
      // XÃ³a táº¥t cáº£ áº£nh NGAY SAU KHI ÄÃƒ BUILD PAYLOAD
      state.data.photos = [];
      persistData();
      renderThumbs();

      // Call both webhooks in parallel
      const results = await Promise.allSettled([
        callAPI(WEBHOOK_URLS.tuvan, payload),
        callAPI(WEBHOOK_URLS.hopdong, payload)
      ]);

      // Handle result 1
      removeTyping('tuvan');
      if (results[0].status === 'fulfilled'){
        const botMsg1 = { id: crypto.randomUUID?.() || String(Math.random()), role:'assistant', content:`ğŸ“‹ TÆ° váº¥n luáº­t:\n\n${results[0].value}`, ts: now(), apiType:'tuvan' };
        state.messages.push(botMsg1); renderMessage(botMsg1);
      } else {
        const errMsg1 = { id: crypto.randomUUID?.() || String(Math.random()), role:'assistant', content:`ğŸ“‹ TÆ° váº¥n luáº­t - Lá»—i: ${results[0].reason}`, ts: now(), error:true };
        state.messages.push(errMsg1); renderMessage(errMsg1);
      }

      // Handle result 2
      removeTyping('hopdong');
      if (results[1].status === 'fulfilled'){
        const botMsg2 = { id: crypto.randomUUID?.() || String(Math.random()), role:'assistant', content:`ğŸ“„ Táº¡o há»£p Ä‘á»“ng:\n\n${results[1].value}`, ts: now(), apiType:'hopdong' };
        state.messages.push(botMsg2); renderMessage(botMsg2);
      } else {
        const errMsg2 = { id: crypto.randomUUID?.() || String(Math.random()), role:'assistant', content:`ğŸ“„ Táº¡o há»£p Ä‘á»“ng - Lá»—i: ${results[1].reason}`, ts: now(), error:true };
        state.messages.push(errMsg2); renderMessage(errMsg2);
      }

      scrollToBottom(); persistMessages();
      
      $send.disabled = false; $input.disabled = false; $input.focus();

      if (!state.data.transaction_type){
        toast('Gá»£i Ã½: ChÆ°a chá»n "Loáº¡i giao dá»‹ch". HÃ£y chá»n Ä‘á»ƒ há»£p Ä‘á»“ng dÃ¹ng Ä‘Ãºng máº«u.');
      }
    }

    function buildPayload(text, historyOverride){
      const history = historyOverride ?? state.messages.slice(-11, -1).map(({role, content, ts}) => ({role, content, ts}));
      const photos = (state.data.photos||[]).map(({id,name,type,size,dataUrl}) => ({id,name,type,size,dataUrl}));
      const profile = { schema_version: state.data.schema_version, transaction_type: state.data.transaction_type, photos };
      return {
        message: text,
        link: window.location.href,
        history,
        profile,
        meta: {
          sent_at: now(),
          source: 'webchat',
          schema_version: SCHEMA_VERSION,
          warnings: profile.transaction_type ? [] : ['transaction_type_missing']
        }
      };
    }

    async function callAPI(url, payload){
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 240000);
      try{
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), signal: controller.signal });
        clearTimeout(timeout);
        if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + res.statusText);
        const ct = res.headers.get('content-type') || '';
        let replyText = '';
        if (ct.includes('application/json')){
          const data = await res.json();
          replyText = extractReply(data);
        } else {
          replyText = await res.text();
        }
        return String(replyText ?? '').trim() || '[KhÃ´ng cÃ³ ná»™i dung tráº£ lá»i]';
      }catch(err){
        clearTimeout(timeout);
        throw err?.message || err;
      }
    }

    function extractReply(obj){
      if (!obj) return '';
      if (typeof obj === 'string') return obj;
      if (typeof obj.message === 'string') return obj.message;
      if (typeof obj.answer === 'string') return obj.answer;
      if (typeof obj.reply === 'string') return obj.reply;
      if (obj.data){
        if (typeof obj.data === 'string') return obj.data;
        if (typeof obj.data.message === 'string') return obj.data.message;
        if (typeof obj.data.answer === 'string') return obj.data.answer;
        if (typeof obj.data.reply === 'string') return obj.data.reply;
      }
      if (Array.isArray(obj.messages)){
        return obj.messages.map(m => m.content || m.text || '').filter(Boolean).join('\n');
      }
      try{ return JSON.stringify(obj); }catch{ return String(obj); }
    }
  </script>
</body>
</html>