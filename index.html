<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat t∆∞ v·∫•n & t·∫°o h·ª£p ƒë·ªìng ‚Ä¢ n8n webhook</title>
  <meta name="description" content="Giao di·ªán chat g·ª≠i tin nh·∫Øn t·ªõi n8n v√† ƒë√≠nh k√®m h·ªì s∆° giao d·ªãch (Lo·∫°i giao d·ªãch, B√™n A/B, t√†i s·∫£n, ·∫£nh t√†i s·∫£n) ƒë·ªÉ t∆∞ v·∫•n & t·∫°o h·ª£p ƒë·ªìng." />
  <style>
    :root{
      --bg:#f7f7f8; --panel:#ffffff; --text:#1f2328; --muted:#6b7280; --border:#e5e7eb;
      --user:#10b981; --assistant:#2563eb; --error:#ef4444; --radius:16px; --shadow:0 6px 24px rgba(0,0,0,.06);
      --accent:#111827;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0e14; --panel:#0f131a; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2937;
        --user:#34d399; --assistant:#60a5fa; --error:#f87171; --shadow:0 6px 24px rgba(0,0,0,.3);
        --accent:#e5e7eb;
      }
    }
    html, body {height:100%}
    body{ margin:0; background:var(--bg); color:var(--text); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";}
    .app{display:grid; grid-template-rows:auto 1fr auto; height:100%;}

    .topbar{
      position:sticky; top:0; z-index:10; display:flex; gap:.75rem; align-items:center;
      padding:.6rem .9rem; border-bottom:1px solid var(--border);
      backdrop-filter:saturate(180%) blur(8px);
      background: color-mix(in oklab, var(--panel) 88%, transparent);
    }
    .brand{ font-weight:700; letter-spacing:.2px; white-space:nowrap }
    .spacer{flex:1}
    .btn{ cursor:pointer; border:none; border-radius:12px; padding:.5rem .8rem; background:var(--assistant); color:white; font-weight:600; box-shadow:var(--shadow);}
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none;}
    .btn.ghost{ background:transparent; color:var(--assistant); border:1px dashed color-mix(in oklab, var(--assistant) 50%, transparent); }

    .select, .input, .textarea, .date, .number{
      border:1px solid var(--border); background:var(--panel); color:var(--text);
      border-radius:12px; padding:.55rem .7rem; font:inherit;
    }
    .select{ padding-right:2rem }

    .messages{ overflow:auto; padding: 1rem; scroll-behavior:smooth; }
    .empty{ opacity:.7; text-align:center; margin-top: 12vh; }

    .msg{ display:grid; grid-template-columns: 40px 1fr; gap:.75rem; margin:.35rem 0; }
    .avatar{ width:40px; height:40px; border-radius:12px; display:grid; place-items:center; font-weight:700; }
    .avatar.user{ background: color-mix(in oklab, var(--user) 20%, var(--panel)); color: var(--user); border:1px solid color-mix(in oklab, var(--user) 45%, var(--border)); }
    .avatar.assistant{ background: color-mix(in oklab, var(--assistant) 20%, var(--panel)); color: var(--assistant); border:1px solid color-mix(in oklab, var(--assistant) 45%, var(--border)); }
    .bubble{ background: var(--panel); border:1px solid var(--border); border-radius: var(--radius); padding:.85rem .95rem; box-shadow: var(--shadow); white-space: pre-wrap; }
    .meta{ font-size:.8rem; color: var(--muted); margin-top:.35rem; }
    .msg.user .bubble{ border-left:4px solid var(--user); }
    .msg.assistant .bubble{ border-left:4px solid var(--assistant); }
    .bubble.error{ border-left-color: var(--error); outline:1px dashed color-mix(in oklab, var(--error) 60%, var(--border)); }
    .typing{ display:inline-grid; grid-auto-flow:column; gap:.25rem; align-items:center; }
    .typing .dot{ width:8px; height:8px; border-radius:50%; background: var(--muted); opacity:.6; animation: blink 1.4s infinite; }
    .typing .dot:nth-child(2){ animation-delay:.2s } .typing .dot:nth-child(3){ animation-delay:.4s }
    @keyframes blink{0%,80%,100%{opacity:.2} 40%{opacity:1}}

    .composer{ border-top:1px solid var(--border); background: color-mix(in oklab, var(--panel) 92%, transparent); padding:.75rem; }
    .composer .row{ display:flex; gap:.6rem; }
    textarea#input{ flex:1; resize:none; max-height:35vh; min-height:46px; padding:.75rem .9rem; border-radius:12px; background:var(--panel); color:var(--text); border:1px solid var(--border); }
    textarea::placeholder{ color:var(--muted); }
    .hint{ font-size:.8rem; color:var(--muted); margin-top:.25rem; display:flex; justify-content:space-between; align-items:center; }
    .hint .links{ display:flex; gap:.5rem; }
    .link{ color: var(--assistant); text-decoration:none; border-bottom:1px dashed color-mix(in oklab, var(--assistant) 60%, transparent) }

    /* Drawer (H·ªì s∆°) */
    .drawer{ position:fixed; inset:0; display:none; }
    .drawer.open{ display:block; }
    .drawer .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
    .drawer .panel{
      position:absolute; right:0; top:0; bottom:0; width:min(720px, 100%); background:var(--panel); color:var(--text);
      border-left:1px solid var(--border); box-shadow:var(--shadow); display:grid; grid-template-rows:auto 1fr auto;
      animation: slideIn .25s ease;
    }
    @keyframes slideIn{ from{ transform:translateX(8px); opacity:.8 } to{ transform:translateX(0); opacity:1 } }
    .panel .header{ padding:.8rem .9rem; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:.6rem;}
    .panel .title{ font-weight:700 }
    .panel .content{ overflow:auto; padding:1rem .9rem }
    .grid{ display:grid; gap:.75rem }
    .cols-2{ grid-template-columns:1fr 1fr }
    .fieldset{ border:1px dashed var(--border); border-radius:14px; padding:.8rem; }
    .legend{ font-weight:700; margin-bottom:.25rem }
    .field{ display:grid; gap:.25rem }
    .field.inline{ grid-template-columns:minmax(120px, 1fr) 2fr; align-items:center }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:.6rem }
    .help{ font-size:.8rem; color:var(--muted) }
    .tag{ display:inline-flex; align-items:center; gap:.4rem; padding:.3rem .55rem; border-radius:999px; border:1px solid var(--border); background:color-mix(in oklab, var(--panel) 90%, transparent); }
    .footer{ border-top:1px solid var(--border); padding:.7rem .9rem; display:flex; gap:.6rem; justify-content:flex-end }

    /* Gallery */
    .gallery{ display:grid; grid-template-columns:repeat(auto-fill, minmax(120px,1fr)); gap:.6rem; }
    .card{ border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--panel); box-shadow:var(--shadow); display:grid; grid-template-rows:auto auto 1fr auto; }
    .card img{ display:block; width:100%; height:100px; object-fit:cover; background:#000; }
    .card .cap{ padding:.4rem .5rem; border-top:1px solid var(--border) }
    .card .cap input{ width:100%; }
    .actions{ display:flex; justify-content:space-between; align-items:center; gap:.4rem; padding:.45rem .5rem; border-top:1px solid var(--border) }
    .chip{ font-size:.75rem; padding:.1rem .4rem; border-radius:999px; border:1px solid var(--border); color:var(--muted) }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">üí¨ Chat t∆∞ v·∫•n lu·∫≠t</div>

      <!-- Lo·∫°i giao d·ªãch -->
      <label class="field inline" style="max-width:380px; margin-left:.5rem;">
        <span class="help">Lo·∫°i giao d·ªãch</span>
        <select id="txnType" class="select">
          <option value="">‚Äî Ch·ªçn ‚Äî</option>
          <option value="mua_ban">Mua b√°n / Chuy·ªÉn nh∆∞·ª£ng</option>
          <option value="dat_coc">ƒê·∫∑t c·ªçc</option>
          <option value="vay">Vay ti·ªÅn</option>
          <option value="the_chap">Th·∫ø ch·∫•p / C·∫ßm c·ªë</option>
          <option value="cho_thue">Cho thu√™ / Cho m∆∞·ª£n</option>
          <option value="tang_cho">T·∫∑ng cho</option>
          <option value="uy_quyen">U·ª∑ quy·ªÅn</option>
          <option value="khac">Kh√°c</option>
        </select>
      </label>

      <button class="btn ghost" id="openProfile" title="M·ªü form H·ªì s∆° giao d·ªãch">H·ªì s∆° giao d·ªãch</button>
      <div class="spacer"></div>
      <button class="btn secondary" id="clearChat" title="X√≥a h·ªôi tho·∫°i hi·ªán t·∫°i">X√≥a</button>
    </header>

    <main id="messages" class="messages" role="log" aria-live="polite" aria-relevant="additions text">
      <div class="empty" id="empty">
        <p><strong>Xin ch√†o!</strong> H√£y nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n.</p>
        <p>H·ªá th·ªëng g·ª≠i ƒë·ªìng th·ªùi t·ªõi 2 webhook: <span class="tag">üìã T∆∞ v·∫•n lu·∫≠t</span> v√† <span class="tag">üìÑ T·∫°o h·ª£p ƒë·ªìng</span>.</p>
        <p class="help">M·∫πo: ch·ªçn <em>Lo·∫°i giao d·ªãch</em> v√† m·ªü <strong>H·ªì s∆°</strong> ƒë·ªÉ ƒëi·ªÅn B√™n A/B, t√†i s·∫£n, ·∫£nh‚Ä¶ H·ª£p ƒë·ªìng s·∫Ω t·ª± ƒëi·ªÅn c√°c d·ªØ li·ªáu ƒë√≥.</p>
      </div>
    </main>

    <footer class="composer">
      <div class="row" style="display:flex; gap:.6rem;">
        <textarea id="input" placeholder="Nh·∫≠p tin nh·∫Øn‚Ä¶ (Enter ƒë·ªÉ g·ª≠i, Shift+Enter ƒë·ªÉ xu·ªëng d√≤ng)"></textarea>
        <button class="btn" id="send">G·ª≠i</button>
      </div>
      <div class="hint">
        <span>G·ª≠i ƒë·ªìng th·ªùi t·ªõi 2 APIs: T∆∞ v·∫•n lu·∫≠t & T·∫°o h·ª£p ƒë·ªìng</span>
        <span class="links">
          <a class="link" href="#" id="examplePayload">Xem payload m·∫´u</a>
          <a class="link" href="#" id="copyProfile">Copy h·ªì s∆° JSON</a>
        </span>
      </div>
    </footer>
  </div>

  <!-- Drawer: H·ªì s∆° giao d·ªãch -->
  <div class="drawer" id="drawer" aria-hidden="true">
    <div class="backdrop" id="closeDrawer"></div>
    <section class="panel" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
      <div class="header">
        <div class="title" id="drawerTitle">üóÇÔ∏è H·ªì s∆° giao d·ªãch</div>
        <span class="tag" id="tagTxn">Ch∆∞a ch·ªçn lo·∫°i giao d·ªãch</span>
        <div class="spacer"></div>
        <button class="btn secondary" id="closeDrawerBtn">ƒê√≥ng</button>
      </div>

      <div class="content grid" style="gap:1rem;">
        <div class="fieldset">
          <div class="legend">1) Th√¥ng tin chung</div>
          <div class="grid cols-2">
            <label class="field">
              <span class="help">Lo·∫°i giao d·ªãch</span>
              <select id="f_txnType" class="select"></select>
            </label>
            <label class="field">
              <span class="help">M·ª•c ƒë√≠ch/ghi ch√∫ (tu·ª≥ ch·ªçn)</span>
              <input id="f_note" class="input" placeholder="VD: chuy·ªÉn nh∆∞·ª£ng QSDƒê, vay ti√™u d√πng‚Ä¶" />
            </label>
          </div>
        </div>

        <div class="fieldset">
          <div class="legend">2) B√™n A</div>
          <div class="grid cols-2">
            <label class="field"><span class="help">H·ªç t√™n</span><input id="A_name" class="input" /></label>
            <label class="field"><span class="help">CCCD/CMND</span><input id="A_id" class="input" /></label>
            <label class="field"><span class="help">Ng√†y c·∫•p</span><input id="A_id_date" type="date" class="input date" /></label>
            <label class="field"><span class="help">N∆°i c·∫•p</span><input id="A_id_place" class="input" /></label>
            <label class="field" style="grid-column:1/-1;"><span class="help">ƒê·ªãa ch·ªâ</span><input id="A_addr" class="input" /></label>
            <label class="field"><span class="help">T√¨nh tr·∫°ng h√¥n nh√¢n</span>
              <select id="A_marital" class="select">
                <option value="">‚Äî Ch·ªçn ‚Äî</option>
                <option>ƒê·ªôc th√¢n</option><option>ƒê√£ k·∫øt h√¥n</option><option>Ly h√¥n</option>
              </select>
            </label>
            <label class="field"><span class="help">ƒêi·ªán tho·∫°i (tu·ª≥ ch·ªçn)</span><input id="A_phone" class="input" /></label>
          </div>
        </div>

        <div class="fieldset">
          <div class="legend">3) B√™n B</div>
          <div class="grid cols-2">
            <label class="field"><span class="help">H·ªç t√™n</span><input id="B_name" class="input" /></label>
            <label class="field"><span class="help">CCCD/CMND</span><input id="B_id" class="input" /></label>
            <label class="field"><span class="help">Ng√†y c·∫•p</span><input id="B_id_date" type="date" class="input date" /></label>
            <label class="field"><span class="help">N∆°i c·∫•p</span><input id="B_id_place" class="input" /></label>
            <label class="field" style="grid-column:1/-1;"><span class="help">ƒê·ªãa ch·ªâ</span><input id="B_addr" class="input" /></label>
            <label class="field"><span class="help">T√¨nh tr·∫°ng h√¥n nh√¢n</span>
              <select id="B_marital" class="select">
                <option value="">‚Äî Ch·ªçn ‚Äî</option>
                <option>ƒê·ªôc th√¢n</option><option>ƒê√£ k·∫øt h√¥n</option><option>Ly h√¥n</option>
              </select>
            </label>
            <label class="field"><span class="help">ƒêi·ªán tho·∫°i (tu·ª≥ ch·ªçn)</span><input id="B_phone" class="input" /></label>
          </div>
        </div>

        <div class="fieldset">
          <div class="legend">4) T√†i s·∫£n</div>
          <div class="grid cols-2">
            <label class="field">
              <span class="help">Lo·∫°i t√†i s·∫£n</span>
              <select id="asset_type" class="select">
                <option value="">‚Äî Ch·ªçn ‚Äî</option>
                <option value="dat_nha">Nh√†/ƒê·∫•t</option>
                <option value="o_to">√î t√¥</option>
                <option value="xe_may">Xe m√°y</option>
                <option value="khac">Kh√°c</option>
              </select>
            </label>
            <label class="field"><span class="help">M√¥ t·∫£ t√≥m t·∫Øt</span><input id="asset_desc" class="input" placeholder="VD: th·ª≠a ƒë·∫•t s·ªë‚Ä¶, di·ªán t√≠ch‚Ä¶, xe √¥ t√¥ bi·ªÉn s·ªë‚Ä¶" /></label>

            <label class="field"><span class="help">S·ªë gi·∫•y t·ªù/ƒê·ªãnh danh</span><input id="asset_id" class="input" placeholder="S·ªï ƒë·ªè/S·ªë khung/S·ªë m√°y/Seri‚Ä¶" /></label>
            <label class="field"><span class="help">Gi√° tr·ªã ∆∞·ªõc t√≠nh (VND)</span><input id="asset_value" class="input" inputmode="numeric" placeholder="VD: 1.200.000.000" /></label>
          </div>
        </div>

        <!-- Nh√°nh MUA B√ÅN -->
        <div class="fieldset" data-branch="mua_ban">
          <div class="legend">5) Th√¥ng tin giao d·ªãch MUA B√ÅN / CHUY·ªÇN NH∆Ø·ª¢NG</div>
          <div class="grid cols-2">
            <label class="field"><span class="help">Gi√° chuy·ªÉn nh∆∞·ª£ng (VND)</span><input id="sale_price" class="input" inputmode="numeric" /></label>
            <label class="field"><span class="help">Ti·ªÅn ƒë·∫∑t c·ªçc (VND, n·∫øu c√≥)</span><input id="sale_deposit" class="input" inputmode="numeric" /></label>
            <label class="field"><span class="help">Ng√†y b√†n giao d·ª± ki·∫øn</span><input id="sale_delivery_date" type="date" class="input date" /></label>
            <label class="field"><span class="help">Thu·∫ø & ph√≠ do b√™n n√†o ch·ªãu?</span>
              <select id="sale_fees" class="select">
                <option value="">‚Äî Ch·ªçn ‚Äî</option>
                <option value="benA">B√™n A</option>
                <option value="benB">B√™n B</option>
                <option value="hai_ben">Hai b√™n tho·∫£ thu·∫≠n</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Nh√°nh VAY/TH·∫æ CH·∫§P -->
        <div class="fieldset" data-branch="vay the_chap">
          <div class="legend">5) Th√¥ng tin VAY &amp; TH·∫æ CH·∫§P/C·∫¶M C·ªê</div>
          <div class="grid cols-2">
            <label class="field"><span class="help">S·ªë ti·ªÅn vay (VND)</span><input id="loan_amount" class="input" inputmode="numeric" /></label>
            <label class="field"><span class="help">L√£i su·∫•t (%/nƒÉm)</span><input id="loan_rate" class="input" inputmode="decimal" placeholder="VD: 9.5" /></label>
            <label class="field"><span class="help">Th·ªùi h·∫°n (th√°ng)</span><input id="loan_term" class="input" inputmode="numeric" placeholder="VD: 24" /></label>
            <label class="field"><span class="help">Ph∆∞∆°ng th·ª©c tr·∫£ n·ª£</span>
              <select id="loan_method" class="select">
                <option value="">‚Äî Ch·ªçn ‚Äî</option>
                <option>G·ªëc ƒë·ªÅu, l√£i gi·∫£m d·∫ßn</option>
                <option>Tr·∫£ l√£i h√†ng th√°ng, g·ªëc cu·ªëi k·ª≥</option>
                <option>Kh√°c</option>
              </select>
            </label>
            <label class="field"><span class="help">ƒêƒÉng k√Ω bi·ªán ph√°p b·∫£o ƒë·∫£m?</span>
              <select id="loan_register" class="select">
                <option value="">‚Äî Ch·ªçn ‚Äî</option>
                <option value="co">C√≥</option>
                <option value="khong">Kh√¥ng</option>
              </select>
            </label>
          </div>
        </div>

        <!-- ·∫¢nh t√†i s·∫£n -->
        <div class="fieldset">
          <div class="legend">6) ·∫¢nh t√†i s·∫£n (Ph·ª• l·ª•c ·∫£nh)</div>
          <div class="grid">
            <div class="row" style="grid-template-columns:1fr auto; gap:.6rem;">
              <input id="photoInput" type="file" class="input" accept="image/*" capture="environment" multiple />
              <button class="btn secondary" id="clearPhotos" type="button">Xo√° t·∫•t c·∫£ ·∫£nh</button>
            </div>
            <div class="help">Ch·ªçn nhi·ªÅu ·∫£nh ho·∫∑c ch·ª•p tr·ª±c ti·∫øp. ·∫¢nh s·∫Ω ƒë∆∞·ª£c n√©n v·ªÅ t·ªëi ƒëa 1600px v√† lo·∫°i EXIF tr∆∞·ªõc khi g·ª≠i ƒë·ªÉ b·∫£o m·∫≠t.</div>
            <div id="gallery" class="gallery"></div>
          </div>
        </div>

      </div>
      <div class="footer">
        <button class="btn secondary" id="saveProfile">L∆∞u</button>
        <button class="btn" id="closeAndSave">L∆∞u & ƒê√≥ng</button>
      </div>
    </section>
  </div>

  <script>
    // ================== CONFIG ==================
    // 2 WEBHOOK URLs
    const WEBHOOK_URLS = {
      tuvan: 'https://flowai.onland.vn/webhook/luongtuvan',
      hopdong: 'https://flowai.onland.vn/webhook/luongtaohopdong'
    };
    const SCHEMA_VERSION = 'lawchat-v2'; // tƒÉng version khi ƒë·ªïi c·∫•u tr√∫c

    const STORAGE = {
      messages: 'n8n:chat:messages',
      profile:  'n8n:chat:profile'
    };

    // ================== DOM GETTERS ==================
    const $input = document.getElementById('input');
    const $send = document.getElementById('send');
    const $messages = document.getElementById('messages');
    const $empty = document.getElementById('empty');
    const $clearChat = document.getElementById('clearChat');

    const $txnTypeTop = document.getElementById('txnType');
    const $openProfile = document.getElementById('openProfile');

    // Drawer elements
    const $drawer = document.getElementById('drawer');
    const $closeDrawer = document.getElementById('closeDrawer');
    const $closeDrawerBtn = document.getElementById('closeDrawerBtn');
    const $tagTxn = document.getElementById('tagTxn');

    // Form fields mapping
    const fields = {
      txnType: document.getElementById('f_txnType'), note: document.getElementById('f_note'),
      A_name: 'A_name', A_id:'A_id', A_id_date:'A_id_date', A_id_place:'A_id_place', A_addr:'A_addr', A_marital:'A_marital', A_phone:'A_phone',
      B_name: 'B_name', B_id:'B_id', B_id_date:'B_id_date', B_id_place:'B_id_place', B_addr:'B_addr', B_marital:'B_marital', B_phone:'B_phone',
      asset_type:'asset_type', asset_desc:'asset_desc', asset_id:'asset_id', asset_value:'asset_value',
      sale_price:'sale_price', sale_deposit:'sale_deposit', sale_delivery_date:'sale_delivery_date', sale_fees:'sale_fees',
      loan_amount:'loan_amount', loan_rate:'loan_rate', loan_term:'loan_term', loan_method:'loan_method', loan_register:'loan_register'
    };
    Object.keys(fields).forEach(k => { if(typeof fields[k]==='string') fields[k] = document.getElementById(fields[k]); });

    const $photoInput = document.getElementById('photoInput');
    const $gallery = document.getElementById('gallery');
    const $clearPhotos = document.getElementById('clearPhotos');
    const $saveProfile = document.getElementById('saveProfile');
    const $closeAndSave = document.getElementById('closeAndSave');

    const $examplePayload = document.getElementById('examplePayload');
    const $copyProfile = document.getElementById('copyProfile');

    // ================== APP STATE ==================
    const state = {
      messages: [],
      profile: {
        schema_version: SCHEMA_VERSION,
        transaction_type: '',
        note: '',
        partyA: { name:'', id:'', id_date:'', id_place:'', address:'', marital:'', phone:'' },
        partyB: { name:'', id:'', id_date:'', id_place:'', address:'', marital:'', phone:'' },
        asset: { type:'', desc:'', id:'', value:'' },
        sale: { price:'', deposit:'', delivery_date:'', fees:'' },
        loan: { amount:'', rate:'', term:'', method:'', register:'' },
        photos: [] // {id, name, type, size, dataUrl, caption}
      }
    };

    // ================== INIT ==================
    // restore messages
    try {
      const saved = JSON.parse(localStorage.getItem(STORAGE.messages) || '[]');
      if (Array.isArray(saved)) {
        state.messages = saved;
        for (const m of state.messages) renderMessage(m);
        if (state.messages.length) $empty?.remove();
        scrollToBottom();
      }
    } catch {}

    // restore profile
    try {
      const prof = JSON.parse(localStorage.getItem(STORAGE.profile) || 'null');
      if (prof && prof.schema_version) {
        state.profile = prof;
      }
    } catch {}
    syncFormFromState(); // fill form & top select
    autosize();

    // ================== EVENTS ==================
    // Autosize textarea
    function autosize(){ $input.style.height='auto'; $input.style.height=Math.min($input.scrollHeight, window.innerHeight*0.35)+'px'; }
    $input.addEventListener('input', autosize);

    // Shortcuts
    $input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    $send.addEventListener('click', sendMessage);

    $clearChat.addEventListener('click', () => {
      if (!confirm('X√≥a to√†n b·ªô h·ªôi tho·∫°i & h·ªì s∆° hi·ªán t·∫°i?')) return;
      state.messages = [];
      localStorage.removeItem(STORAGE.messages);
      $messages.innerHTML = '<div class="empty" id="empty"><p><strong>ƒê√£ x√≥a.</strong> B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán m·ªõi!</p></div>';
      toast('ƒê√£ x√≥a h·ªôi tho·∫°i.');
    });

    // Drawer open/close
    $openProfile.addEventListener('click', () => openDrawer(true));
    $closeDrawer.addEventListener('click', () => openDrawer(false));
    $closeDrawerBtn.addEventListener('click', () => openDrawer(false));
    $saveProfile.addEventListener('click', () => { syncStateFromForm(); persistProfile(); toast('ƒê√£ l∆∞u h·ªì s∆°.'); });
    $closeAndSave.addEventListener('click', () => { syncStateFromForm(); persistProfile(); openDrawer(false); toast('ƒê√£ l∆∞u & ƒë√≥ng.'); });

    // Topbar select mirrors form select
    $txnTypeTop.addEventListener('change', () => {
      fields.txnType.value = $txnTypeTop.value;
      syncStateFromForm(); persistProfile(); updateBranches(); paintTag();
    });

    fields.txnType.addEventListener('change', () => {
      $txnTypeTop.value = fields.txnType.value;
      syncStateFromForm(); persistProfile(); updateBranches(); paintTag();
    });

    // Photo input
    $photoInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      const limitCount = 24;
      if (state.profile.photos.length + files.length > limitCount) {
        toast(`T·ªëi ƒëa ${limitCount} ·∫£nh. M·ªôt s·ªë ·∫£nh s·∫Ω kh√¥ng ƒë∆∞·ª£c th√™m.`);
      }
      for (const file of files.slice(0, limitCount - state.profile.photos.length)) {
        const item = await readAndCompressImage(file, 1600, 0.75); // remove EXIF via canvas
        state.profile.photos.push(item);
      }
      persistProfile();
      renderGallery();
      $photoInput.value = '';
    });

    $clearPhotos.addEventListener('click', () => {
      if (!state.profile.photos.length) return;
      if (!confirm('Xo√° to√†n b·ªô ·∫£nh trong ph·ª• l·ª•c?')) return;
      state.profile.photos = [];
      persistProfile(); renderGallery();
    });

    $examplePayload.addEventListener('click', (e) => {
      e.preventDefault();
      const example = buildPayload('[V√≠ d·ª•] Lu·∫≠t h√¥n nh√¢n gia ƒë√¨nh c√≥ hi·ªáu l·ª±c t·ª´ nƒÉm n√†o?');
      alert('Payload m·∫´u g·ª≠i t·ªõi 2 webhooks:\n\n' + JSON.stringify(example, null, 2) + '\n\nTrong n8n, l·∫•y tin nh·∫Øn m·ªõi b·∫±ng:\n{{ $json.body.message }}\n\nLink hi·ªán t·∫°i:\n{{ $json.body.link }}\n\nH·ªì s∆° giao d·ªãch:\n{{ $json.body.profile | json }}');
    });

    $copyProfile.addEventListener('click', (e) => {
      e.preventDefault();
      navigator.clipboard.writeText(JSON.stringify(state.profile, null, 2)).then(()=>toast('ƒê√£ copy h·ªì s∆° JSON'));
    });

    // ============== UI HELPERS ==============
    function toast(text){
      const t = document.createElement('div');
      t.textContent = text;
      Object.assign(t.style, { position:'fixed', left:'50%', bottom:'20px', transform:'translateX(-50%)',
        background:'var(--panel)', color:'var(--text)', padding:'10px 14px', border:'1px solid var(--border)', borderRadius:'12px', boxShadow:'var(--shadow)', zIndex:10000 });
      document.body.appendChild(t); setTimeout(() => t.remove(), 1800);
    }
    function scrollToBottom(){ $messages.scrollTop = $messages.scrollHeight; }
    function now(){ return new Date().toISOString(); }
    function fmt(ts){ try{ const d=new Date(ts); return d.toLocaleString('vi-VN'); }catch{ return ts; } }

    function renderMessage(m){
      const wrap = document.createElement('div'); wrap.className = `msg ${m.role}`;
      const avatar = document.createElement('div'); avatar.className = `avatar ${m.role}`; avatar.textContent = m.role === 'user' ? 'U' : 'A';
      const bubble = document.createElement('div'); bubble.className = 'bubble' + (m.error ? ' error' : '');
      // show a compact tag if message was sent with profile
      const hasProfile = m.meta?.hasProfile;
      bubble.textContent = m.content + (hasProfile ? '\n\n‚Äî\n(ƒê√£ g·ª≠i k√®m h·ªì s∆° giao d·ªãch)' : '');
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = m.error ? `L·ªói ‚Ä¢ ${fmt(m.ts)}` : `${m.role==='user' ? 'B·∫°n' : 'Tr·ª£ l√Ω'} ‚Ä¢ ${fmt(m.ts)}`;
      const right = document.createElement('div'); right.appendChild(bubble); right.appendChild(meta);
      wrap.appendChild(avatar); wrap.appendChild(right); $messages.appendChild(wrap);
    }

    function renderTyping(apiType){
      const wrap = document.createElement('div'); wrap.className='msg assistant'; wrap.id=`typing-${apiType}`;
      const avatar = document.createElement('div'); avatar.className='avatar assistant'; avatar.textContent='A';
      const bubble = document.createElement('div'); bubble.className='bubble';
      const typing = document.createElement('div'); typing.className='typing'; typing.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>'; bubble.appendChild(typing);
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = apiType==='tuvan' ? 'üìã ƒêang t∆∞ v·∫•n‚Ä¶' : 'üìÑ ƒêang t·∫°o h·ª£p ƒë·ªìng‚Ä¶';
      const right = document.createElement('div'); right.appendChild(bubble); right.appendChild(meta);
      wrap.appendChild(avatar); wrap.appendChild(right); $messages.appendChild(wrap); scrollToBottom();
    }
    function removeTyping(apiType){ document.getElementById(`typing-${apiType}`)?.remove(); }
    function persistMessages(){ localStorage.setItem(STORAGE.messages, JSON.stringify(state.messages.slice(-200))); }
    function persistProfile(){ localStorage.setItem(STORAGE.profile, JSON.stringify(state.profile)); paintTag(); }

    function paintTag(){
      const map = {
        '': 'Ch∆∞a ch·ªçn lo·∫°i giao d·ªãch',
        'mua_ban': 'Lo·∫°i: MUA B√ÅN/CHUY·ªÇN NH∆Ø·ª¢NG',
        'dat_coc': 'Lo·∫°i: ƒê·∫∂T C·ªåC',
        'vay': 'Lo·∫°i: VAY',
        'the_chap': 'Lo·∫°i: TH·∫æ CH·∫§P/C·∫¶M C·ªê',
        'cho_thue': 'Lo·∫°i: CHO THU√ä/CHO M∆Ø·ª¢N',
        'tang_cho': 'Lo·∫°i: T·∫∂NG CHO',
        'uy_quyen': 'Lo·∫°i: U·ª∂ QUY·ªÄN',
        'khac': 'Lo·∫°i: KH√ÅC'
      };
      $tagTxn.textContent = map[state.profile.transaction_type] || 'Lo·∫°i giao d·ªãch';
    }

    function openDrawer(open){
      $drawer.classList.toggle('open', !!open);
      if (open) { renderGallery(); updateBranches(); }
    }

    function syncFormFromState(){
      // fill selects in both places
      $txnTypeTop.value = state.profile.transaction_type || '';
      fields.txnType.innerHTML = $txnTypeTop.innerHTML; // clone options
      fields.txnType.value = state.profile.transaction_type || '';
      fields.note.value = state.profile.note || '';
      // A
      const A = state.profile.partyA, B = state.profile.partyB, as = state.profile.asset, sale = state.profile.sale, loan = state.profile.loan;
      fields.A_name.value=A.name||''; fields.A_id.value=A.id||''; fields.A_id_date.value=A.id_date||''; fields.A_id_place.value=A.id_place||'';
      fields.A_addr.value=A.address||''; fields.A_marital.value=A.marital||''; fields.A_phone.value=A.phone||'';
      // B
      fields.B_name.value=B.name||''; fields.B_id.value=B.id||''; fields.B_id_date.value=B.id_date||''; fields.B_id_place.value=B.id_place||'';
      fields.B_addr.value=B.address||''; fields.B_marital.value=B.marital||''; fields.B_phone.value=B.phone||'';
      // Asset
      fields.asset_type.value=as.type||''; fields.asset_desc.value=as.desc||''; fields.asset_id.value=as.id||''; fields.asset_value.value=as.value||'';
      // Sale
      fields.sale_price.value=sale.price||''; fields.sale_deposit.value=sale.deposit||''; fields.sale_delivery_date.value=sale.delivery_date||''; fields.sale_fees.value=sale.fees||'';
      // Loan
      fields.loan_amount.value=loan.amount||''; fields.loan_rate.value=loan.rate||''; fields.loan_term.value=loan.term||''; fields.loan_method.value=loan.method||''; fields.loan_register.value=loan.register||'';
      paintTag(); updateBranches();
    }

    function syncStateFromForm(){
      state.profile.transaction_type = fields.txnType.value || '';
      state.profile.note = fields.note.value || '';
      const A = state.profile.partyA, B = state.profile.partyB, as = state.profile.asset, sale = state.profile.sale, loan = state.profile.loan;
      A.name=fields.A_name.value; A.id=fields.A_id.value; A.id_date=fields.A_id_date.value; A.id_place=fields.A_id_place.value;
      A.address=fields.A_addr.value; A.marital=fields.A_marital.value; A.phone=fields.A_phone.value;
      B.name=fields.B_name.value; B.id=fields.B_id.value; B.id_date=fields.B_id_date.value; B.id_place=fields.B_id_place.value;
      B.address=fields.B_addr.value; B.marital=fields.B_marital.value; B.phone=fields.B_phone.value;
      as.type=fields.asset_type.value; as.desc=fields.asset_desc.value; as.id=fields.asset_id.value; as.value=fields.asset_value.value;
      sale.price=fields.sale_price.value; sale.deposit=fields.sale_deposit.value; sale.delivery_date=fields.sale_delivery_date.value; sale.fees=fields.sale_fees.value;
      loan.amount=fields.loan_amount.value; loan.rate=fields.loan_rate.value; loan.term=fields.loan_term.value; loan.method=fields.loan_method.value; loan.register=fields.loan_register.value;
    }

    function updateBranches(){
      const t = (state.profile.transaction_type||'').trim();
      document.querySelectorAll('[data-branch]').forEach(el => {
        const keys = el.getAttribute('data-branch').split(/\s+/);
        el.style.display = keys.includes(t) ? 'block' : 'none';
      });
    }

    function renderGallery(){
      $gallery.innerHTML = '';
      if (!state.profile.photos.length){
        const p = document.createElement('p'); p.className='help'; p.textContent='Ch∆∞a c√≥ ·∫£nh n√†o.';
        $gallery.appendChild(p); return;
      }
      for (const photo of state.profile.photos){
        const card = document.createElement('div'); card.className='card'; card.dataset.id = photo.id;
        const img = document.createElement('img'); img.src = photo.dataUrl;
        const meta = document.createElement('div'); meta.className='actions';
        meta.innerHTML = `<span class="chip">${Math.round(photo.size/1024)} KB</span>
                          <button class="btn secondary" type="button" data-del="${photo.id}">Xo√°</button>`;
        const cap = document.createElement('div'); cap.className='cap';
        const capInput = document.createElement('input'); capInput.className='input'; capInput.placeholder='Ch√∫ th√≠ch ·∫£nh (tu·ª≥ ch·ªçn)'; capInput.value = photo.caption || '';
        cap.appendChild(capInput);
        card.appendChild(img); card.appendChild(meta); card.appendChild(cap);
        $gallery.appendChild(card);

        capInput.addEventListener('input', () => { photo.caption = capInput.value; persistProfile(); });
        meta.querySelector('button[data-del]').addEventListener('click', () => {
          state.profile.photos = state.profile.photos.filter(p => p.id !== photo.id); persistProfile(); renderGallery();
        });
      }
    }

    // Read + compress image, remove EXIF via canvas
    async function readAndCompressImage(file, maxSize=1600, quality=0.75){
      const id = crypto.randomUUID?.() || String(Math.random());
      const name = file.name || ('image-' + id + '.jpg');
      const type = 'image/jpeg';
      const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject; reader.readAsDataURL(file);
      });
      const img = await new Promise((resolve, reject) => { const i=new Image(); i.onload=()=>resolve(i); i.onerror=reject; i.src=dataUrl; });
      const {width, height} = fitContain(img.width, img.height, maxSize);
      const canvas = document.createElement('canvas'); canvas.width=width; canvas.height=height;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
      const out = canvas.toDataURL(type, quality);
      const size = Math.ceil(atob(out.split(',')[1]).length);
      return { id, name, type, size, dataUrl: out, caption:'' };
    }
    function fitContain(w, h, max){ if(Math.max(w,h)<=max) return {width:w, height:h}; const r = w>h ? max/w : max/h; return {width:Math.round(w*r), height:Math.round(h*r)}; }

    // ============== SEND MESSAGE ==============
    async function sendMessage(){
      const text = $input.value.trim();
      if (!text) return;

      $send.disabled = true; $input.disabled = true;
      $empty?.remove();

      const hasProfile = Boolean(state.profile.transaction_type || state.profile.partyA.name || state.profile.partyB.name || state.profile.asset.type || state.profile.photos.length);
      const userMsg = { id: crypto.randomUUID?.() || String(Math.random()), role:'user', content:text, ts: now(), meta: { hasProfile } };
      state.messages.push(userMsg); renderMessage(userMsg); scrollToBottom();
      $input.value=''; autosize();

      // typing indicators
      renderTyping('tuvan'); renderTyping('hopdong');

      // History (10 tin tr∆∞·ªõc ƒë√≥, kh√¥ng t√≠nh tin hi·ªán t·∫°i)
      const history = state.messages.slice(-11, -1).map(({role, content, ts}) => ({role, content, ts}));

      // Build payload
      const payload = buildPayload(text, history);

      // Call both webhooks in parallel
      const promises = [
        callAPI(WEBHOOK_URLS.tuvan, payload, 'T∆∞ v·∫•n lu·∫≠t'),
        callAPI(WEBHOOK_URLS.hopdong, payload, 'T·∫°o h·ª£p ƒë·ªìng')
      ];
      const results = await Promise.allSettled(promises);

      // Handle result 1
      removeTyping('tuvan');
      if (results[0].status === 'fulfilled'){
        const botMsg1 = { id: crypto.randomUUID?.() || String(Math.random()), role:'assistant', content:`üìã T∆∞ v·∫•n lu·∫≠t:\n\n${results[0].value}`, ts: now(), apiType:'tuvan' };
        state.messages.push(botMsg1); renderMessage(botMsg1);
      } else {
        const errMsg1 = { id: crypto.randomUUID?.() || String(Math.random()), role:'assistant', content:`üìã T∆∞ v·∫•n lu·∫≠t - L·ªói: ${results[0].reason}`, ts: now(), error:true };
        state.messages.push(errMsg1); renderMessage(errMsg1);
      }

      // Handle result 2
      removeTyping('hopdong');
      if (results[1].status === 'fulfilled'){
        const botMsg2 = { id: crypto.randomUUID?.() || String(Math.random()), role:'assistant', content:`üìÑ T·∫°o h·ª£p ƒë·ªìng:\n\n${results[1].value}`, ts: now(), apiType:'hopdong' };
        state.messages.push(botMsg2); renderMessage(botMsg2);
      } else {
        const errMsg2 = { id: crypto.randomUUID?.() || String(Math.random()), role:'assistant', content:`üìÑ T·∫°o h·ª£p ƒë·ªìng - L·ªói: ${results[1].reason}`, ts: now(), error:true };
        state.messages.push(errMsg2); renderMessage(errMsg2);
      }

      scrollToBottom(); persistMessages();
      $send.disabled = false; $input.disabled = false; $input.focus();

      // Friendly hint if missing txn type
      if (!state.profile.transaction_type){
        toast('G·ª£i √Ω: Ch∆∞a ch·ªçn "Lo·∫°i giao d·ªãch". H√£y ch·ªçn ƒë·ªÉ h·ª£p ƒë·ªìng d√πng ƒë√∫ng m·∫´u.');
      }
    }

    function buildPayload(text, historyOverride){
      const history = historyOverride ?? state.messages.slice(-11, -1).map(({role, content, ts}) => ({role, content, ts}));
      // To keep payload compact, duplicate the photo list with only metadata + dataUrl (already compressed)
      const photos = (state.profile.photos||[]).map(({id,name,type,size,dataUrl,caption}) => ({id,name,type,size,dataUrl,caption}));
      const profile = { ...state.profile, photos };
      return {
        message: text,
        link: window.location.href,
        history,
        profile,
        meta: {
          sent_at: now(),
          source: 'webchat',
          schema_version: SCHEMA_VERSION,
          warnings: profile.transaction_type ? [] : ['transaction_type_missing']
        }
      };
    }

    async function callAPI(url, payload){
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 240000);
      try{
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), signal: controller.signal });
        clearTimeout(timeout);
        if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + res.statusText);
        const ct = res.headers.get('content-type') || '';
        let replyText = '';
        if (ct.includes('application/json')){
          const data = await res.json();
          replyText = extractReply(data);
        } else {
          replyText = await res.text();
        }
        return String(replyText ?? '').trim() || '[Kh√¥ng c√≥ n·ªôi dung tr·∫£ l·ªùi]';
      }catch(err){
        clearTimeout(timeout);
        throw err?.message || err;
      }
    }

    function extractReply(obj){
      if (!obj) return '';
      if (typeof obj === 'string') return obj;
      if (typeof obj.message === 'string') return obj.message;
      if (typeof obj.answer === 'string') return obj.answer;
      if (typeof obj.reply === 'string') return obj.reply;
      if (obj.data){
        if (typeof obj.data === 'string') return obj.data;
        if (typeof obj.data.message === 'string') return obj.data.message;
        if (typeof obj.data.answer === 'string') return obj.data.answer;
        if (typeof obj.data.reply === 'string') return obj.data.reply;
      }
      if (Array.isArray(obj.messages)){
        return obj.messages.map(m => m.content || m.text || '').filter(Boolean).join('\n');
      }
      try{ return JSON.stringify(obj); }catch{ return String(obj); }
    }

  </script>
</body>
</html>
